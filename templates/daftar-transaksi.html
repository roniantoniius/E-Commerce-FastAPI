{% extends 'base.html' %}

{% block title %}Daftar Transaksi - Warung Omega{% endblock %}

{% block content %}
<div class="container mt-4">
    <br>
    <h1 style="text-align: center;">Daftar Transaksi Anda, {{ username }}</h1>
    <br>
    <div id="transaction-items">
        {% if not username %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                Swal.fire({
                    icon: 'warning',
                    title: 'Oops...',
                    text: 'Kamu harus login terlebih dahulu untuk melihat transaksi yang kamu lakukan.',
                    confirmButtonText: 'Login Sekarang',
                    confirmButtonColor: '#3085d6',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = "/";
                    }
                });
            });
        </script>
        {% else %}
        <div class="accordion" id="accordionExample">
            <div class="accordion-item">
                <h1 class="accordion-header" id="headingOne" style="background-color: white; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);">
                    <button class="accordion-button d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne" style="background-color: white; box-shadow: none;">
                        <img src="{{ url_for('static', path='images/logo putih omega-no bg.png') }}" alt="logo" class="mb-logo" style="width: 200px; height: auto;">
                        <h4 class="fw-bold" style="flex-grow: 1; text-align: right; font-weight: bold;">Total Transaksi: <span id="total-price">Rp 0</span></h4>
                    </button>
                </h1>
                <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                        
                        <!-- Loop through transaksi_list items -->
                        {% for transaksi in transaksi_list %}
                        <div class="cart-item row mb-3 align-items-center" id="cart-item-{{ transaksi.id_transaksi }}">
                            <div class="col-md-6 d-flex align-items-center">
                                
                                <div class="mr-3">
                                    <h5>ID Transaksi: {{ transaksi.id_transaksi }}</h5>
                                </div>
                                <div class="mr-3" style="padding-left: 20px;">
                                    <p>Produk: <strong>{{ transaksi.products }}</strong></p>
                                </div>
                                <div class="mr-3" style="padding-left: 20px;">
                                    <td>
                                        <span class="badge 
                                            {% if transaksi.status == 'True' %}bg-success
                                            {% else %}bg-warning
                                            {% endif %}
                                            " style="font-size: 18px; font-weight: bold; color: #ffffff;"
                                        >
                                            {{ transaksi.status }}
                                        </span>
                                    </td>
                                </div>
                            </div>
                        
                            <!-- Price section -->
                            <div class="col-md-6 text-right">
                                <h5 style="flex-grow: 1; text-align: right; font-weight: bold;">Rp {{ transaksi.total }}</h5>
                            </div>
                        </div>
                        <hr>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
<div style="text-align: center; padding-top: 20px; padding-bottom: 20px;">
    <div style="display: inline-flex; justify-content: center;">
      <a href="/products-page"><button class="btn-flat btn-hover">Kembali Belanja</button></a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function calculateTotalPrice() {
        // Ambil semua harga total transaksi
        let totalPrice = 0;
        const hargaElements = document.querySelectorAll('.cart-item h5');

        hargaElements.forEach(hargaElement => {
            let hargaText = hargaElement.innerText.replace('Rp', '').trim();
            hargaText = hargaText.split('.')[0];
            hargaText = hargaText.replace(/\./g, '');

            let harga = parseInt(hargaText, 10);

            if (!isNaN(harga)) {
                totalPrice += harga;
            }
        });

        // Update total harga di UI
        document.getElementById('total-price').innerText = 'Rp ' + totalPrice.toLocaleString('id-ID');
    }

    // Panggil fungsi untuk menghitung total harga saat halaman dimuat
    document.addEventListener('DOMContentLoaded', calculateTotalPrice);
</script>
{% endblock %}
